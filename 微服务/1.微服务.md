# 1. 微服务

关键字: ==一致性==. ==CAP.== ==BASE==. ==ACID==

## 1. 微服务

要保证: ==**高可用**==, ==**高并发**==, 高性能



## 2. CAP, BASE 理论

### 2.1 ==**CAP 定理:**==

==**CAP 理论**==: 一个分布式系统最多只能同时满足 ==**一致性**==, ==**可用性**== 和 ==**分区容错性**== 这三项中的两项.

- ==一致性: Consistency==. 即更新操作成功并返回客户端完成后, 所有节点在==**同一时间**==的数据完全一致.(这里说的一致性是==强一致性==)
- ==可用性: Availability==. 即服务一致可用, 而且响应时间为正常的响应时间.
- ==分区容错性: Partition tolerance==. 即分布式系统在遇到某节点或网络分区故障的时候, 仍然能够对外提供满足一致性和可用性的服务.



​	例如, 在一个机房中, 部署 3 台机器, 分别部署了 3 个应用. 为了保证可用性, 就会为每个应用再部署2 台机器, 这样每个应用都有三台机器, 当其中的一个应用的一台机器发生故障, 无法提供服务的时候, 还有 2 台机器可以提供服务, 这样就保证了可用性.

​	假如还有一个机房, 此时有两个机房, 假如其中一个机房断电了, 那么这个机房就无法在提供服务, 但是此时还有一个机房可以提供服务, 这样就保证了分区容错性.虽然分区容错性可以满足一致性和可用性, 但是这里的一致性就不一定是 ==强一致性了!==例如机房 A 在上海, 机房 B 在北京, 那么一般情况下,  ==**CDN(内容分发网络)**==会判断用户的 IP, 然后就近连接, 比如上海的用户, 会被 CDN 连接到上海的机房, 北京的用户连接到北京的机房, 假如此时上海的机房突然跪了, 那么虽然上海的用户可以连接到北京的机房, 但是数据就不一定是强一致性了, 因为北京的机房可能没有上海用户的数据, 即便有, 也可能无法 100%的拥有上海用户的数据.毕竟数据的同步是需要时间的.

​	所以, 一般情况下, 如果要保证强一致性, 可能就无法保证可用性! 如果保证可用性, 可能就无法保证强一致性.



==**CAP 权衡:**==

​	通过 CAP 理论, 知道一个分布式系统, 无法同时满足一致性, 可用性和分区容错性. 那么舍弃哪个呢?

​	对于大多数互联网应用来说, 主机众多, 部署分散, 而且现在的集群规模越来越大, 所以节点故障, 网络故障是常态, 而且要保证服务可用性达到 N 个 9, 也就是要保证 99.99...%的时间可以用. 也就是要保证可用性和分区容错性, 也就是 A 和 P, 舍弃一致性, 也就是舍弃 C, 但是不是说完全舍弃一致性, 而是退而求其次, 达到==**最终一致性**==.

​	对于涉及到钱财这样不能有一丝错误的情况, 则必须保证强一致性, 也就是必须保证 C,网络故障宁可停止服务!! 这样保证 C 和 A, 舍弃 P.

​	因此, 一般分布式系统中, 要么保证 ==一致性== 和 ==分区容错性==,这种架构就叫 ==**CP系统(一致性系统)**==, 要么保证 ==可用性== 和 ==分区容错性==, 也就是 ==**AP系统(可用性系统)**==. CP 系统是要求强一致性, 所以一般都是金融系统使用. 而 AP 是可用性系统,只要不和钱相关的系统, 一般都可以使用 AP 系统.



一致性:

1. 强一致性: 要么一起成功要么一起失败.
2. 弱一致性: 最终一致性就是软一致性的一种特殊情况.
3. 顺序一致性



### 2.2 BASE 理论

==**BASE理论**==: BASE 理论是对 CAP 理论的延伸, 核心思想是在大规模分布式系统中, ==**即使无法到达强一致性, 但是应用可以采取合适的方式达到最终一致性.**==

- ==**基本可用**==: Basically Available. 基本可用是指分布式系统在发生故障的时候, 允许损失一部分可用性! 即 ==**保证核心可用**==. 也就是在==**发生故障的时候, 只要保证核心功能可用就行了(即 基本可用)**==. 比如电商大促的时候, 为了应对访问量激增, 部分用户可能会被引导到降级页面, 服务层也可能只能提供降级服务.
- ==**软状态**==: Soft state. 软状态是指允许系统存在==**中间状态. 而该中间状态不会影响系统整体可用性.**== 分布式系统中一般一份数据至少会有三个副本, 允许不同节点间副本同步的延时就是软状态的体现.
- ==**最终一致性**==: Eventual Consistency. 最终一致性是指系统中的所有数据副本在经过一段时间后, 最终能够达到一致性的状态. 弱一致性和强一致性相反, 最终一致性就是弱一致性的一种特殊情况.



ACID 是传统数据库常用的设计理念, 追求的是 强一致性! 而 BASE 支持的是==大规模分布式系统, 提供牺牲强一致性获得高可用==.



