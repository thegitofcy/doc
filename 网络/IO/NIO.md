关键字: `IO 多路复用`, `轮询->Selector`, `channel`

# 1. 阻塞非阻塞/同步异步

## 阻塞非阻塞

阻塞和非阻塞是请求发出后, 等待数据返回时的状态.

- 数据返回前, 服务挂起,无法进行其他操作的话, 就是阻塞的.
- 数据返回前, 服务没有挂起, 可以继续执行, 则是非阻塞的.



## 异步/同步

同步和异步是根据是否主动询问数据是否读取完来区分的.

- 应用层==**主动去系统内核询问**==数据是否读取完毕, 这是同步, 如果数据未读取完, 再根据阻塞/非阻塞进行区分.
- 应用层不用主动去询问, 系统内核在读取完数据后, 会==**主动通知**==应用层. 这是异步.



总结:

- **==同步异步关注的是 任务完成后消息通知的机制(主动询问还是被通知).==**
- **==阻塞和非阻塞关注的是 等待任务完成时请求者的状态(挂起还是可以继续执行其他操作)==**





# 2. NIO

## 1. NIO 简介

- NIO `同步非阻塞 IO`, 是在 java1.4 中引入的. 弥补了原来的 IO 的不足.提供了高速的,面向块的 IO.

- 对应 IO 模型是 `多路复用 IO`
- NIO = selector + channel + buffer



## 2. NIO 和 BIO 的区别

### 1. 使用 `Channel` 代替 `Stream`

Stream 是有`方向性`的, 输入流只能读取数据, 输出流只能写入数据, 并且`读写都是阻塞的`

Channel 是`双向`的, 既可以写数据也可以读数据. `读写都有两种模式`, 既可以阻塞的读写也可以非阻塞的读写



### 2. 使用 `Selector` 监控多条 channel

channel 的读写既可以是阻塞的也可以是非阻塞的, 那么从 channel 中读取数据的时候, 如果是非阻塞的, 可能读的一瞬间是没有值的, 但是读完的下一秒就有值了, 这种情况就需要不停的询问 channel, 如果自己来实现比较繁琐麻烦, 所以使用 `Selector`, Selector + 非阻塞式 就方便很多.



### 3. 可以在一个线程里处理多个 channel I/O

也就是说可以在一个线程里处理多个 channel 的 I/O.







### 3.1 I/O 简介

I/O(输入/输出)指的是计算机与外部世界或者是应用程序与计算机的其他部分之间的接口. 所有的I/O主体实际上是内置在操作系统中的. 单独的程序一般是让系统为他们完成大部分的工作.



### 3.2 为什么使用 NIO
NIO 的创建目的是为了让 Java 程序员可以实现高速 IO 而无需编写自定义的本机代码. NIO 将最耗时的 IO 操作(填充和提取缓冲区)转移会操作系统, 从而极大的提供速度.

### 3.3 流与块的区别

原来的 IO 和 NIO 最大的区别是数据的打包和传输方式.

IO 使用的是==*流*==的方式处理数据, NIO 采用的是==*块*==的方式处理数据.

面向流的 IO 系统一次一个字节的处理数据. 一个输入流产生一个字节的数据,一个输出流消费一个字节的数据.为流式数据创建过滤器非常容易,连接几个过滤器, 以便一个过滤器只负责单个复杂复杂处理机制的一部分. 这样比较简单. 但是, 面向流的 IO 通常会非常慢.

面向块的系统以块的形式处理数据, 每一个操作都在一步中产生或者消费一个数据块. 按块处理数据比按流处理数据要快的多.

# 3. 通道(Channel)和缓冲区(Buffer)

## 1 概述

通道和缓冲区是 NIO 的核心对象, 几乎每一个 IO 操作都要使用他们.

通道是对原 IO 包中流的模拟. `channel是双向的, 既可以读有可以写`, 到任何目的地(或者来自任何地方)的数据都必须通过一个` Channel`对象. 发送给通道的所有对象都必须首先放在`缓冲区(Buffer)中`, 同样的, 从通道中读取数据也要先放到`缓冲区(Buffer)中`.

## 2. Buffer

Buffer 是一个对象. 它包含一些要`写入`或者`刚读出`的数据, NIO 和 IO 的一个区别就是 NIO 中加入了 Buffer 对象. 在面向流的 IO 中,是将数据直接写入或者直接读到 Stream 中.

在 NIO 中,所有数据都是通过` Buffer`处理. 在读取数据时, 它是直接将数据读到` Buffer`中. 在写数据是, 他是写到` Buffer`中. 任何时候要访问 NIO 的数据,都是将数据放到` Buffer`中.

`Buffer`实质上是一个数组, 通常是一个字节数数组, 但是也可以使其他任何类型的数据.

### 1 buffer类型

最常用的` Buffer` 是` ByteBuffer`. 一个` ByteBuffer`可以在其底层字节数组上进行` get/set`操作.

每一种 Java 基本类型都对应一种穿冲区类型:
- `ByteBuffer`
- `CharBuffer`
- `ShortBuffer`
- `IntBuffer`
- `FloatBuffer`
- `LongBuffer`
- `DoubleBuffer`

每一个` Buffer 类`都是` Buffer 接口`的一个子类. 除了` ByteBuffer`, 每一个` Buffer`类都有完全一样的操作. 只是他们所处理的数据类型不一样.

## 3. Channel

`Channel` 是一个对象. 可以通过它读取或者写入数据.

所有的数据都是通过` Buffer`对象来处理, 永远不会将字节写入` Channel`中. 相反, 是将数据写入包含一个或者多个字节的`Buffer 缓冲区`. 同样,也不能直接从` Channel`中读取字节, 而是将数据从` Channel`读入到` Buffer`, 再从缓冲区读取这个字节.

### 4.5 Channel 类型
通道与流的不同之处在于==**通道是双向的.**== 而流只是在一个方向上移动(一个流必须是 InputStream 或者 OutputStream 的子类). 而通道可以用于读, 写或者同时用于读写.

因为` Channel`是双向的, 所以通道可以比流更好的反应底层操作系统的真实情况.



# 4. NIO 中的读和写